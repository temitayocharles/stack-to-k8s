@page "/health-analytics"
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@using System.Text.Json

<PageTitle>Health Analytics</PageTitle>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-warning text-white">
                <div class="card-body p-4">
                    <h3 class="mb-0">üìä Health Analytics Center</h3>
                    <p class="mb-0 opacity-8">Advanced health insights and predictive analytics</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Health Score -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üéØ Patient Health Score Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Patient ID</label>
                            <div class="input-group">
                                <InputNumber @bind-Value="selectedPatientId" class="form-control" />
                                <button class="btn btn-primary" @onclick="LoadPatientHealthScore">
                                    <i class="fas fa-search"></i> Analyze
                                </button>
                            </div>
                        </div>
                    </div>

                    @if (patientHealthScore != null)
                    {
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-@GetScoreColor(patientHealthScore.health_score.overall_score) text-white text-center">
                                    <div class="card-body">
                                        <h2 class="mb-1">@patientHealthScore.health_score.overall_score.ToString("F1")</h2>
                                        <p class="mb-0">@patientHealthScore.health_score.score_category Health Score</p>
                                        <small class="opacity-75">Last updated: @DateTime.Parse(patientHealthScore.health_score.last_updated.ToString()).ToString("MMM dd, HH:mm")</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">üìä Score Breakdown</h6>
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <span>Vital Signs</span>
                                                <span>@patientHealthScore.score_breakdown.vital_signs_score.ToString("F1")</span>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-primary" style="width: @patientHealthScore.score_breakdown.vital_signs_score%"></div>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <span>AI Analysis</span>
                                                <span>@patientHealthScore.score_breakdown.ai_analysis_score.ToString("F1")</span>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-info" style="width: @patientHealthScore.score_breakdown.ai_analysis_score%"></div>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <span>Trends</span>
                                                <span>@patientHealthScore.score_breakdown.trend_score.ToString("F1")</span>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-success" style="width: @patientHealthScore.score_breakdown.trend_score%"></div>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <span>Compliance</span>
                                                <span>@patientHealthScore.score_breakdown.compliance_score.ToString("F1")</span>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-warning" style="width: @patientHealthScore.score_breakdown.compliance_score%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title text-danger">‚ö†Ô∏è Risk Factors</h6>
                                        @if (patientHealthScore.risk_factors?.Count > 0)
                                        {
                                            <ul class="list-unstyled mb-0">
                                                @foreach (var risk in patientHealthScore.risk_factors)
                                                {
                                                    <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>@risk</li>
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <p class="text-success mb-0"><i class="fas fa-check-circle me-2"></i>No significant risk factors identified</p>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary">üí° Recommendations</h6>
                                        <ul class="list-unstyled mb-0">
                                            @foreach (var recommendation in patientHealthScore.recommendations)
                                            {
                                                <li><i class="fas fa-lightbulb text-warning me-2"></i>@recommendation</li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">üìà Health Trends</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <h6 class="text-success">Improving Areas</h6>
                                                <ul class="list-unstyled">
                                                    @foreach (var area in patientHealthScore.trends.improving_areas)
                                                    {
                                                        <li><i class="fas fa-arrow-up text-success me-2"></i>@area</li>
                                                    }
                                                </ul>
                                            </div>
                                            <div class="col-md-4">
                                                <h6 class="text-info">Stable Areas</h6>
                                                <ul class="list-unstyled">
                                                    @foreach (var area in patientHealthScore.trends.stable_areas)
                                                    {
                                                        <li><i class="fas fa-minus text-info me-2"></i>@area</li>
                                                    }
                                                </ul>
                                            </div>
                                            <div class="col-md-4">
                                                <h6 class="text-warning">Declining Areas</h6>
                                                <ul class="list-unstyled">
                                                    @foreach (var area in patientHealthScore.trends.declining_areas)
                                                    {
                                                        <li><i class="fas fa-arrow-down text-warning me-2"></i>@area</li>
                                                    }
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üîÆ Predictive Analytics</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-primary mb-3" @onclick="LoadPredictiveAnalytics">
                        <i class="fas fa-crystal-ball me-2"></i>Generate Predictions
                    </button>

                    @if (predictiveAnalytics != null)
                    {
                        <div class="alert alert-info">
                            <h6 class="alert-heading">ü§ñ AI Model Info</h6>
                            <p class="mb-1"><strong>Model:</strong> @predictiveAnalytics.prediction_model.model_version</p>
                            <p class="mb-1"><strong>Confidence:</strong> @predictiveAnalytics.prediction_model.confidence_level.ToString("P")</p>
                            <p class="mb-0"><strong>Horizon:</strong> @predictiveAnalytics.prediction_model.prediction_horizon</p>
                        </div>

                        <div class="card mb-3">
                            <div class="card-body">
                                <h6 class="card-title">üè• Health Predictions</h6>
                                <div class="mb-2">
                                    <span class="fw-bold">Cardiovascular Risk:</span>
                                    <div class="progress mt-1" style="height: 8px;">
                                        <div class="progress-bar bg-danger" style="width: @predictiveAnalytics.health_predictions.cardiovascular_risk%"></div>
                                    </div>
                                    <small class="text-muted">@predictiveAnalytics.health_predictions.cardiovascular_risk.ToString("F1")%</small>
                                </div>
                                <div class="mb-2">
                                    <span class="fw-bold">Diabetes Risk:</span>
                                    <div class="progress mt-1" style="height: 8px;">
                                        <div class="progress-bar bg-warning" style="width: @predictiveAnalytics.health_predictions.diabetes_risk%"></div>
                                    </div>
                                    <small class="text-muted">@predictiveAnalytics.health_predictions.diabetes_risk.ToString("F1")%</small>
                                </div>
                                <div class="mb-2">
                                    <span class="fw-bold">Hospitalization Risk:</span>
                                    <div class="progress mt-1" style="height: 8px;">
                                        <div class="progress-bar bg-info" style="width: @predictiveAnalytics.health_predictions.hospitalization_risk%"></div>
                                    </div>
                                    <small class="text-muted">@predictiveAnalytics.health_predictions.hospitalization_risk.ToString("F1")%</small>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">üìà Trend Forecasts</h6>
                                <p class="mb-1"><strong>Blood Pressure:</strong> @predictiveAnalytics.trend_forecasts.blood_pressure_trend</p>
                                <p class="mb-1"><strong>Weight:</strong> @predictiveAnalytics.trend_forecasts.weight_trend</p>
                                <p class="mb-0"><strong>Overall Health:</strong> @predictiveAnalytics.trend_forecasts.overall_health_trajectory</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Population Analytics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üë• Population Health Analytics</h5>
                    <button class="btn btn-outline-primary" @onclick="LoadPopulationAnalytics">
                        <i class="fas fa-users me-2"></i>Load Population Data
                    </button>
                </div>
                <div class="card-body">
                    @if (populationAnalytics != null)
                    {
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white text-center">
                                    <div class="card-body">
                                        <h3 class="mb-1">@populationAnalytics.population_overview.total_patients</h3>
                                        <small>Total Patients</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white text-center">
                                    <div class="card-body">
                                        <h3 class="mb-1">@populationAnalytics.population_overview.active_monitoring</h3>
                                        <small>Active Monitoring</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white text-center">
                                    <div class="card-body">
                                        <h3 class="mb-1">@populationAnalytics.demographics.average_age.ToString("F0")</h3>
                                        <small>Average Age</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white text-center">
                                    <div class="card-body">
                                        <h3 class="mb-1">@populationAnalytics.utilization_stats.telemedicine_adoption.ToString("F1")%</h3>
                                        <small>Telemedicine Adoption</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">üìä Demographics</h6>
                                        
                                        <h6 class="mt-3">Age Distribution</h6>
                                        @foreach (var ageGroup in populationAnalytics.demographics.age_distribution)
                                        {
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>@ageGroup.AgeGroup</span>
                                                <span>@ageGroup.Count patients</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 6px;">
                                                <div class="progress-bar" style="width: @((double)ageGroup.Count / populationAnalytics.population_overview.total_patients * 100)%"></div>
                                            </div>
                                        }

                                        <h6 class="mt-3">Gender Distribution</h6>
                                        @foreach (var gender in populationAnalytics.demographics.gender_distribution)
                                        {
                                            <div class="d-flex justify-content-between mb-1">
                                                <span>@gender.Gender</span>
                                                <span>@gender.Count patients</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 6px;">
                                                <div class="progress-bar bg-info" style="width: @((double)gender.Count / populationAnalytics.population_overview.total_patients * 100)%"></div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">üíä Health Metrics</h6>
                                        
                                        <div class="alert alert-light">
                                            <h6>Average Vital Signs</h6>
                                            <p class="mb-1"><strong>Heart Rate:</strong> @populationAnalytics.health_metrics.average_vital_signs.average_heart_rate bpm</p>
                                            <p class="mb-1"><strong>Blood Pressure:</strong> @populationAnalytics.health_metrics.average_vital_signs.average_blood_pressure mmHg</p>
                                            <p class="mb-1"><strong>Temperature:</strong> @populationAnalytics.health_metrics.average_vital_signs.average_temperature¬∞C</p>
                                            <p class="mb-0"><strong>O2 Saturation:</strong> @populationAnalytics.health_metrics.average_vital_signs.average_oxygen_saturation%</p>
                                        </div>

                                        <h6>Chronic Conditions Prevalence</h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <small><strong>Diabetes:</strong> @populationAnalytics.health_metrics.chronic_conditions_prevalence.diabetes%</small>
                                            </div>
                                            <div class="col-6">
                                                <small><strong>Hypertension:</strong> @populationAnalytics.health_metrics.chronic_conditions_prevalence.hypertension%</small>
                                            </div>
                                            <div class="col-6">
                                                <small><strong>Heart Disease:</strong> @populationAnalytics.health_metrics.chronic_conditions_prevalence.heart_disease%</small>
                                            </div>
                                            <div class="col-6">
                                                <small><strong>Asthma:</strong> @populationAnalytics.health_metrics.chronic_conditions_prevalence.asthma%</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Outcomes Analysis -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üéØ Treatment Outcomes Analysis</h5>
                    <button class="btn btn-outline-primary" @onclick="LoadOutcomesAnalysis">
                        <i class="fas fa-chart-line me-2"></i>Load Outcomes Data
                    </button>
                </div>
                <div class="card-body">
                    @if (outcomesAnalysis != null)
                    {
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-success text-white text-center">
                                    <div class="card-body">
                                        <h4 class="mb-1">@outcomesAnalysis.patient_outcomes.total_patients_treated</h4>
                                        <small>Patients Treated</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white text-center">
                                    <div class="card-body">
                                        <h4 class="mb-1">@outcomesAnalysis.patient_outcomes.average_treatment_duration.ToString("F0")min</h4>
                                        <small>Avg Treatment Time</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white text-center">
                                    <div class="card-body">
                                        <h4 class="mb-1">@outcomesAnalysis.diagnostic_accuracy.ai_accuracy_rate.ToString("F1")%</h4>
                                        <small>AI Accuracy Rate</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-primary text-white text-center">
                                    <div class="card-body">
                                        <h4 class="mb-1">@outcomesAnalysis.treatment_effectiveness.successful_treatments%</h4>
                                        <small>Success Rate</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">üéØ Treatment Effectiveness</h6>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <span>Successful Treatments</span>
                                                <span class="fw-bold text-success">@outcomesAnalysis.treatment_effectiveness.successful_treatments%</span>
                                            </div>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-success" style="width: @outcomesAnalysis.treatment_effectiveness.successful_treatments%"></div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <span>Medication Adherence</span>
                                                <span class="fw-bold text-info">@outcomesAnalysis.treatment_effectiveness.medication_adherence%</span>
                                            </div>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-info" style="width: @outcomesAnalysis.treatment_effectiveness.medication_adherence%"></div>
                                            </div>
                                        </div>
                                        <div class="mb-0">
                                            <div class="d-flex justify-content-between">
                                                <span>Readmission Rate</span>
                                                <span class="fw-bold text-warning">@outcomesAnalysis.treatment_effectiveness.readmission_rate%</span>
                                            </div>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-warning" style="width: @outcomesAnalysis.treatment_effectiveness.readmission_rate%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">üí∞ Cost Effectiveness</h6>
                                        <div class="row text-center">
                                            <div class="col-12 mb-3">
                                                <h3 class="text-primary">${{outcomesAnalysis.cost_effectiveness.cost_per_patient}}</h3>
                                                <small class="text-muted">Cost per Patient</small>
                                            </div>
                                            <div class="col-6">
                                                <h4 class="text-success">@outcomesAnalysis.cost_effectiveness.cost_savings_vs_traditional%</h4>
                                                <small class="text-muted">Cost Savings</small>
                                            </div>
                                            <div class="col-6">
                                                <h4 class="text-info">@outcomesAnalysis.cost_effectiveness.roi_percentage%</h4>
                                                <small class="text-muted">ROI</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show position-fixed bottom-0 end-0 m-3" role="alert" style="z-index: 1050;">
        <i class="fas fa-exclamation-triangle me-2"></i>@errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
    </div>
}

@code {
    private int selectedPatientId = 1;
    private string errorMessage = string.Empty;

    // Data
    private dynamic? patientHealthScore;
    private dynamic? predictiveAnalytics;
    private dynamic? populationAnalytics;
    private dynamic? outcomesAnalysis;

    private async Task LoadPatientHealthScore()
    {
        if (selectedPatientId <= 0) return;

        try
        {
            var response = await Http.GetAsync($"http://localhost:5170/api/healthanalytics/patient/{selectedPatientId}/health-score");

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                patientHealthScore = JsonSerializer.Deserialize<dynamic>(content);
            }
            else
            {
                errorMessage = $"Failed to load health score: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading health score: {ex.Message}";
        }
    }

    private async Task LoadPredictiveAnalytics()
    {
        if (selectedPatientId <= 0)
        {
            errorMessage = "Please select a patient first";
            return;
        }

        try
        {
            var response = await Http.GetAsync($"http://localhost:5170/api/healthanalytics/predictive-analytics/{selectedPatientId}");

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                predictiveAnalytics = JsonSerializer.Deserialize<dynamic>(content);
            }
            else
            {
                errorMessage = $"Failed to load predictive analytics: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading predictive analytics: {ex.Message}";
        }
    }

    private async Task LoadPopulationAnalytics()
    {
        try
        {
            var response = await Http.GetAsync("http://localhost:5170/api/healthanalytics/population/analytics");

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                populationAnalytics = JsonSerializer.Deserialize<dynamic>(content);
            }
            else
            {
                errorMessage = $"Failed to load population analytics: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading population analytics: {ex.Message}";
        }
    }

    private async Task LoadOutcomesAnalysis()
    {
        try
        {
            var response = await Http.GetAsync("http://localhost:5170/api/healthanalytics/outcomes/analysis");

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                outcomesAnalysis = JsonSerializer.Deserialize<dynamic>(content);
            }
            else
            {
                errorMessage = $"Failed to load outcomes analysis: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading outcomes analysis: {ex.Message}";
        }
    }

    private string GetScoreColor(double score) => score switch
    {
        >= 85 => "success",
        >= 70 => "primary",
        >= 55 => "warning",
        _ => "danger"
    };
}